{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">




<h1 id="handling-file-upload-in-flask">Handling File Upload in Flask</h1>
<p>Most web application allow for file uploads. In this article, I will show you how you can implement that feature in a flask app.</p>
<h3 id="flask-application-structure">Flask Application Structure</h3>
<p><img class="img-fluid" style="max-width: 100%; height: auto;" src="{{ url_for('static', filename='/images/file_uploads/file_upload_structure.png') }}" alt="App structure"></p>
<p>Create the application&#39;s structure as shown above using the <code>mkdir</code> and <code>touch</code> commands in your terminal. For example:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #ff8080; ">$</span> mkdir my_new_project 
<span style="color: #888888"># this creates an empty directory in the current working directory</span>

<span style="color: #ff8080; ">$</span> touch my_new_project/my_new_file 
<span style="color: #888888"># this creates an empty file in the new directory</span>
</pre>
<h3 id="useful-dependancies">Useful dependancies</h3>
<p>Make sure to be working in a virtual environment before you begin the project. Create and activate your virtual environment as follows:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #ff8080; ">$</span> mkvirtualenv venv <span style="color: #888888"># I am using virtualenvwrapper</span>
</pre>
<p>Learn how to set up and use virtual environment wrapper <a href="https://gitauharrison-blog.herokuapp.com/virtualenvwrapper">here</a>.</p>
<p>Then, install <code>flask</code>:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #ff8080; ">$</span> pip3 install flask
</pre>
<p>Since the application will make use of forms, install <code>flask-wtf</code>:</p>
<pre style="margin: 30; line-height: 125%">(venv)<span style="color: #ff8080; ">$</span> pip3 install flask<span style="color: #333333">-</span>wtf
</pre>
<p>Other useful dependancies can be:</p>
<pre style="margin: 30; line-height: 125%">(venv)<span style="color: #ff8080; ">$</span> pip3 install flask<span style="color: #333333">-</span>bootstrap <span style="color: #888888"># cross-site responsiveness</span>
(venv)<span style="color: #ff8080; ">$</span> pip3 install python<span style="color: #333333">-</span>dotenv <span style="color: #888888"># load flask environment variables</span>
</pre>
<h4 id="what-we-will-do">What We Will Do</h4>
<p>This article covers:</p>
<ol>
<li>Accepting file uploads</li>
<li>File Submission in Flask</li>
<li>Securing uploaded files</li>
<li>Consuming uploaded files</li>
</ol>
<p><strong>NOTE:</strong> The assumption is you have a basic understanding of how to create forms manually, as I will not be reviewing manual creation of forms, but rather focus on how to render forms that are styled using <code>flask-bootstrap</code>.</p>
<h3 id="1-acccepting-file-uploads">1. Acccepting File Uploads</h3>
<p>Let us set up our application to display a flask web form as follows:</p>
<p class="code-title">__init__.py: create an instance of the application</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> Flask
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask_bootstrap</span> <span style="color: #008800; font-weight: bold">import</span> Bootstrap
    
app <span style="color: #333333">=</span> Flask(__name__)
bootstrap <span style="color: #333333">=</span> Bootstrap(app)
    
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> routes, errors
</pre>
<p>Here, we initialize the application by first creating an instance of the <code>flask</code> app and other useful dependancies.</p>
<p class="code-title">base.html: template for our base style</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> Remove the back slashes <span style="color: #333333">--&gt;</span>

{<span style="color: #333333">%</span> extends <span style="background-color: #fff0f0">&#39;bootstrap/base.html</span><span style="color: #666666; font-weight: bold; background-color: #fff0f0">&#39;</span><span style="background-color: #fff0f0"> %}</span>
    
{<span style="color: #333333">%</span> block title <span style="color: #333333">%</span>}
    {<span style="color: #333333">%</span> <span style="color: #008800; font-weight: bold">if</span> title <span style="color: #333333">%</span>}
        \{\{ title \}\} <span style="color: #333333">-</span> File Upload
    {<span style="color: #333333">%</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #333333">%</span>}
        Welcome to Flask
    {<span style="color: #333333">%</span> endif <span style="color: #333333">%</span>}
    
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
    
{<span style="color: #333333">%</span> block navbar <span style="color: #333333">%</span>}
    <span style="color: #333333">&lt;</span>nav class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;navbar navbar-default&quot;</span><span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;container&quot;</span><span style="color: #333333">&gt;</span>
            <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;navbar-header&quot;</span><span style="color: #333333">&gt;</span>
                <span style="color: #333333">&lt;</span>button <span style="color: #007020">type</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;button&quot;</span> class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;navbar-toggle collapsed&quot;</span> data<span style="color: #333333">-</span>toggle<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;collapse&quot;</span> data<span style="color: #333333">-</span>target<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;#bs-example-navbar-collapse-1&quot;</span> aria<span style="color: #333333">-</span>expanded<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;false&quot;</span><span style="color: #333333">&gt;</span>
                    <span style="color: #333333">&lt;</span>span class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;sr-only&quot;</span><span style="color: #333333">&gt;</span>Toggle navigation<span style="color: #333333">&lt;/</span>span<span style="color: #333333">&gt;</span>
                    <span style="color: #333333">&lt;</span>span class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;icon-bar&quot;</span><span style="color: #333333">&gt;&lt;/</span>span<span style="color: #333333">&gt;</span>
                    <span style="color: #333333">&lt;</span>span class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;icon-bar&quot;</span><span style="color: #333333">&gt;&lt;/</span>span<span style="color: #333333">&gt;</span>
                    <span style="color: #333333">&lt;</span>span class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;icon-bar&quot;</span><span style="color: #333333">&gt;&lt;/</span>span<span style="color: #333333">&gt;</span>
                <span style="color: #333333">&lt;/</span>button<span style="color: #333333">&gt;</span>
                <span style="color: #333333">&lt;</span>a class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;navbar-brand&quot;</span> href<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;\{\{ url_for(&#39;index&#39;) \}\}&quot;</span><span style="color: #333333">&gt;</span>File Upload<span style="color: #333333">&lt;/</span>a<span style="color: #333333">&gt;</span>
            <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
            <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;collapse navbar-collapse&quot;</span> <span style="color: #007020">id</span><span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;bs-example-navbar-collapse-1&quot;</span><span style="color: #333333">&gt;</span>
                <span style="color: #333333">&lt;</span>ul class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;nav navbar-nav&quot;</span><span style="color: #333333">&gt;</span>
                    <span style="color: #333333">&lt;</span>li<span style="color: #333333">&gt;&lt;</span>a href<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;\{\{ url_for(&#39;index&#39;) \}\}&quot;</span><span style="color: #333333">&gt;</span>Home<span style="color: #333333">&lt;/</span>a<span style="color: #333333">&gt;&lt;/</span>li<span style="color: #333333">&gt;</span>                    
                <span style="color: #333333">&lt;/</span>ul<span style="color: #333333">&gt;</span>                
            <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
    <span style="color: #333333">&lt;/</span>nav<span style="color: #333333">&gt;</span>
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
    
{<span style="color: #333333">%</span> block content <span style="color: #333333">%</span>}
    <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;container&quot;</span><span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> You can add more features to your app here, such <span style="color: #008800; font-weight: bold">as</span> message flashing <span style="color: #333333">--&gt;</span>
        {<span style="color: #333333">%</span> block app_content <span style="color: #333333">%</span>}{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
    <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
</pre>
<p>Our <code>base</code> template inherits all the styles from the <code>flask-bootstrap</code>&#39;s <code>base.html</code> template. Noteworthy, we use the block called <code>app_content</code> to hold the details of our application.</p>
<p class="code-title">forms.py: create form</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask_wtf</span> <span style="color: #008800; font-weight: bold">import</span> FlaskForm
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask_wtf.file</span> <span style="color: #008800; font-weight: bold">import</span> FileField
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">wtforms</span> <span style="color: #008800; font-weight: bold">import</span> SubmitField
    
    
<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">UploadForm</span>(FlaskForm):
    <span style="color: #007020">file</span> <span style="color: #333333">=</span> FileField(<span style="background-color: #fff0f0">&#39;Upload File&#39;</span>, render_kw<span style="color: #333333">=</span>{<span style="background-color: #fff0f0">&quot;class&quot;</span>: <span style="background-color: #fff0f0">&quot;dropzone&quot;</span>})
    submit <span style="color: #333333">=</span> SubmitField(<span style="background-color: #fff0f0">&#39;Submit&#39;</span>)
</pre>
<p>Since we are working with file uploads, <code>flask-wtf</code> provides <code>FileField</code> which specifically handles forms that allow for file inputs. Instead of importing <code>FileField</code> from <code>wtforms</code> as is normally the case when working with string and boolean input data, file uploads requires that we import  <code>FileField</code> from <code>flask_wtf.file</code> as seen above.</p>
<p class="code-title">index.html: display upload form</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> Remove back slashes <span style="color: #333333">--&gt;</span>

{<span style="color: #333333">%</span> extends <span style="background-color: #fff0f0">&quot;base.html&quot;</span> <span style="color: #333333">%</span>}
{<span style="color: #333333">%</span> <span style="color: #008800; font-weight: bold">import</span> <span style="background-color: #fff0f0">&#39;bootstrap/wtf.html&#39;</span> <span style="color: #008800; font-weight: bold">as</span> wtf <span style="color: #333333">%</span>}
    
{<span style="color: #333333">%</span> block app_content <span style="color: #333333">%</span>}
    <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;row&quot;</span><span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-2&quot;</span><span style="color: #333333">&gt;</span>
            <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> empty <span style="color: #333333">--&gt;</span>
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-8&quot;</span><span style="color: #333333">&gt;</span>
            \{\{ wtf<span style="color: #333333">.</span>quick_form(form) \}\}             
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-2&quot;</span><span style="color: #333333">&gt;</span>
                <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> empty <span style="color: #333333">--&gt;</span>
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>        
    <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;&lt;</span>hr<span style="color: #333333">&gt;</span>
       
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
</pre>
<p><code>flask-bootstrap</code> allows us to quickly create forms using <code>\{\{ wtf.quick_form(form) \}\}</code>. This not only saves time but also adds default form styles from <em>Bootstrap</em>.</p>
<p class="code-title">config.py: register application configuration</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>


<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Config</span>(<span style="color: #007020">object</span>):
    SECRET_KEY <span style="color: #333333">=</span> os<span style="color: #333333">.</span>environ<span style="color: #333333">.</span>get(<span style="background-color: #fff0f0">&#39;SECRET_KEY&#39;</span>) <span style="color: #000000; font-weight: bold">or</span> <span style="background-color: #fff0f0">&#39;you-will-never-guess&#39;</span>
</pre>
<p>Since we are creating a web form which is most likely to make changes in our application, the first thing we want to do is to ensure that the web form is secure against <a href="https://owasp.org/www-community/attacks/csrf">CSRF</a> attacks. A secret key is needed to ensure for the security of our form. </p>
<p>Once this secret key is configured, we need to register it in our application instance. Update <code>__init__.py</code> file as follows:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> Flask
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask_bootstrap</span> <span style="color: #008800; font-weight: bold">import</span> Bootstrap
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">config</span> <span style="color: #008800; font-weight: bold">import</span> Config  <span style="color: #888888"># &lt;----------- new</span>
    
app <span style="color: #333333">=</span> Flask(__name__)
app<span style="color: #333333">.</span>config<span style="color: #333333">.</span>from_object(Config)  <span style="color: #888888"># &lt;----------- new</span>
bootstrap <span style="color: #333333">=</span> Bootstrap(app)
    
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> routes, errors
</pre>
<p class="code-title">routes.py: create view function used to render our form</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> render_template, url_for, request, redirect
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app.forms</span> <span style="color: #008800; font-weight: bold">import</span> UploadForm
    
    
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/index&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>():
    form <span style="color: #333333">=</span> UploadForm()        
    <span style="color: #008800; font-weight: bold">return</span> render_template(<span style="background-color: #fff0f0">&#39;index.html&#39;</span>, title<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Home&#39;</span>, form<span style="color: #333333">=</span>form)
</pre>
<p class="code-title">file_upload.py: define flask application instance</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app
</pre>
<p>With the application structure and content now complete, we can run our script by first importing it in our top-level Python script.</p>
<p>Flask requires that we set a few environment variables which need to run when the application is first fired up. Based on the principle of <em>separation of concerns</em>, as has been the case throughout the creation of the application, we will initialize Flask environment variables in <code>.flaskenv</code> file as seen below:</p>
<p class="code-title">flaskenv: initialize Flask environment variables</p>
<pre style="margin: 30; line-height: 125%">FLASK_APP<span style="color: #333333">=</span>file_upload<span style="color: #333333">.</span>py
FLASK_ENV<span style="color: #333333">=</span>development
FLASK_DEBUG<span style="color: #333333">=</span><span style="color: #007020">True</span>
</pre>
<p>Believe it or not, the application is complete! Let us fire up our flask server by running the command below in our terminal:</p>
<pre style="margin: 30; line-height: 125%">(venv)<span style="color: #ff8080; ">$</span> flask run
</pre>
<p>You should be able to see this:</p>
<p><img class="img-fluid" style="max-width: 100%; height: auto;" src="{{ url_for('static', filename='/images/file_uploads/accepting_file_uploads.png') }}" alt="Accepting File Uploads">
<p>Browse the compelete code <a href="https://github.com/GitauHarrison/handling-file-uploads-in-flask/commit/40a9928c1c978b7fcf878cb33dd3a0b9874a77f0">here</a>.</p>
<h3 id="2-file-submissions-in-flask">2. File Submissions in Flask</h3>
<p>Form fileds in <code>Flask</code> are generally accessed used using <code>request.form</code> dictionary. For file fields, <code>request.files</code> is used.</p>
<p>We need to update the <code>index()</code> function in <code>routes.py</code> to access and save files as seen below:</p>
<p class="code-title">routes.py: submit a file</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app
    <span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> render_template, url_for, request, redirect
    <span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app.forms</span> <span style="color: #008800; font-weight: bold">import</span> UploadForm
    
    
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/index&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>():
    form <span style="color: #333333">=</span> UploadForm()
    <span style="color: #008800; font-weight: bold">if</span> request<span style="color: #333333">.</span>method <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;POST&#39;</span>:
        uploaded_file <span style="color: #333333">=</span> request<span style="color: #333333">.</span>files[<span style="background-color: #fff0f0">&#39;file&#39;</span>]
        <span style="color: #008800; font-weight: bold">if</span> uploaded_file<span style="color: #333333">.</span>filename <span style="color: #333333">!=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>:
            uploaded_file<span style="color: #333333">.</span>save(uploaded_file<span style="color: #333333">.</span>filename)
        <span style="color: #008800; font-weight: bold">return</span> redirect(url_for(<span style="background-color: #fff0f0">&#39;index&#39;</span>))
    <span style="color: #008800; font-weight: bold">return</span> render_template(<span style="background-color: #fff0f0">&#39;index.html&#39;</span>, title<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Home&#39;</span>, form<span style="color: #333333">=</span>form)
</pre>
<p>We want to send our form only when the method used is <code>POST</code>. We store a file object in the variable called <code>uploaded_file</code> which uses <code>request.files</code> dictionary to access the data in the <code>FileField</code>. If that file object is not empty, then we call the <code>save()</code> function to store that data in a local disk in the application&#39;s top-level directory. After each submission, we display the home page by redirecting the URL to the <code>index()</code> function.</p>
<p>Reload your page and choose a file by clicking the <em>Choose File</em> button. Hit the <em>Submit</em> button and you will notice that a file has been saved in you top-level directory.</p>
<p>Browse the file submission code <a href="https://github.com/GitauHarrison/handling-file-uploads-in-flask/commit/3fb49d3f3c46aba655cee2aed76252da4223fefd">here</a>.</p>
<h3 id="3-file-upload-security">3. File Upload Security</h3>
<p>A rule of thumb when building web application is that data submitted by clients should never be trusted. Hence, the need for strict form validation. This data could maliciously be intended to crash the server by because the file is too large that the disk space in the server is completely filled, or the file is named in a manner that it tricks the server into rewriting system configuration files.</p>
<p>Basic steps we can take to protect our application would be:</p>
<ul>
<li>Limiting the size of files uploaded to the application&#39;s server</li>
<li>Validating the names of the uploaded files</li>
<li>Scanning the file content before submission</li>
</ul>
<h4 id="limit-file-size">Limit File Size</h4>
<p>Flask provides an option to limit the file size a client can upload. In <code>config.py</code>, we can add this configuration:</p>
<pre style="margin: 30; line-height: 125%">MAX_CONTENT_LENGTH <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1024</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">1024</span> <span style="color: #888888"># equal to 1 MB</span>
</pre>
<p>If you try to upload a file larger than 1 MB, the application will now refuse it. The server will return a <code>413</code> Request Entity Too Large error because the data value transmitted exceeds the capacity limit.</p>
<h4 id="validating-filenames">Validating Filenames</h4>
<p>We can implement very simple form validation to check that the file extension used by clients are accepted by the application. <code>flask-wtf</code> provides validators such as <code>FileAllowed</code> and <code>FileRequired</code> when creating forms. Look at the example below:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #007020">file</span> <span style="color: #333333">=</span> FileField(<span style="background-color: #fff0f0">&#39;File&#39;</span>, validators<span style="color: #333333">=</span>[FileRequired()])
</pre>
<p>For our application, we will list all allowed extension in the <code>config.py</code> file as seen below:</p>
<pre style="margin: 30; line-height: 125%">UPLOAD_EXTENSIONS <span style="color: #333333">=</span> [<span style="background-color: #fff0f0">&#39;.jpg&#39;</span>, <span style="background-color: #fff0f0">&#39;.png&#39;</span>, <span style="background-color: #fff0f0">&#39;.gif&#39;</span>]
</pre>
<p>These are the current configurations:</p>
<p class="code-title">config.py: Securing file uploads</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>


<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Config</span>(<span style="color: #007020">object</span>):
    SECRET_KEY <span style="color: #333333">=</span> os<span style="color: #333333">.</span>environ<span style="color: #333333">.</span>get(<span style="background-color: #fff0f0">&#39;SECRET_KEY&#39;</span>) <span style="color: #000000; font-weight: bold">or</span> <span style="background-color: #fff0f0">&#39;you-will-never-guess&#39;</span>
    MAX_CONTENT_LENGTH <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1024</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">1024</span>
    UPLOAD_EXTENSIONS <span style="color: #333333">=</span> [<span style="background-color: #fff0f0">&#39;.jpg&#39;</span>, <span style="background-color: #fff0f0">&#39;.png&#39;</span>, <span style="background-color: #fff0f0">&#39;.gif&#39;</span>]
</pre>
<p>Let us implement this configiration in our <code>index()</code> method in <code>routes.py</code>:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> render_template, url_for, request, redirect, abort
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app.forms</span> <span style="color: #008800; font-weight: bold">import</span> UploadForm
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
    
    
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/index&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>():
    form <span style="color: #333333">=</span> UploadForm()
    <span style="color: #008800; font-weight: bold">if</span> request<span style="color: #333333">.</span>method <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;POST&#39;</span>:
        <span style="color: #888888"># start of update</span>
        uploaded_file <span style="color: #333333">=</span> request<span style="color: #333333">.</span>files[<span style="background-color: #fff0f0">&#39;file&#39;</span>]
        filename <span style="color: #333333">=</span> uploaded_file<span style="color: #333333">.</span>filename
        <span style="color: #008800; font-weight: bold">if</span> filename <span style="color: #333333">!=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>:
            file_ext <span style="color: #333333">=</span> os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>splitext(filename)[<span style="color: #0000DD; font-weight: bold">1</span>]
            <span style="color: #008800; font-weight: bold">if</span> file_ext <span style="color: #000000; font-weight: bold">not</span> <span style="color: #000000; font-weight: bold">in</span> app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_EXTENSIONS&#39;</span>]:
                abort(<span style="color: #0000DD; font-weight: bold">400</span>)
                <span style="color: #888888"># end of update</span>
            uploaded_file<span style="color: #333333">.</span>save(uploaded_file<span style="color: #333333">.</span>filename)
        <span style="color: #008800; font-weight: bold">return</span> redirect(url_for(<span style="background-color: #fff0f0">&#39;index&#39;</span>))
    <span style="color: #008800; font-weight: bold">return</span> render_template(<span style="background-color: #fff0f0">&#39;index.html&#39;</span>, title<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Home&#39;</span>, form<span style="color: #333333">=</span>form)
</pre>
<p>Files whose extensions are not configured will return a <code>400</code> Bad Request error when a client tries to upload them. The application checks for the file in the <code>FileField</code> and extracts the extension. If the file extension does not exist in the application configuration, flask aborts the upload are returns the 400 error.</p>
<p>Another way to secure files based on their names would be to use Werkzeug&#39;s <a href="https://werkzeug.palletsprojects.com/en/1.0.x/utils/#werkzeug.utils.secure_filename">secure_filename</a> function. No matter how complicated or malicious a filename is, <code>secure_filename()</code> reduces it to a flat filename.</p>
<p class="code-title">routes.py: using secure_filename function</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> render_template, url_for, request, redirect, abort
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app.forms</span> <span style="color: #008800; font-weight: bold">import</span> UploadForm
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">werkzeug.utils</span> <span style="color: #008800; font-weight: bold">import</span> secure_filename <span style="color: #888888"># &lt;--------- new update</span>
    
    
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/index&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>():
    form <span style="color: #333333">=</span> UploadForm()
    <span style="color: #008800; font-weight: bold">if</span> request<span style="color: #333333">.</span>method <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;POST&#39;</span>:
        uploaded_file <span style="color: #333333">=</span> request<span style="color: #333333">.</span>files[<span style="background-color: #fff0f0">&#39;file&#39;</span>]
        filename <span style="color: #333333">=</span> secure_filename(uploaded_file<span style="color: #333333">.</span>filename)  <span style="color: #888888"># &lt;--------- new update</span>
        <span style="color: #008800; font-weight: bold">if</span> filename <span style="color: #333333">!=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>:
            file_ext <span style="color: #333333">=</span> os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>splitext(filename)[<span style="color: #0000DD; font-weight: bold">1</span>]
            <span style="color: #008800; font-weight: bold">if</span> file_ext <span style="color: #000000; font-weight: bold">not</span> <span style="color: #000000; font-weight: bold">in</span> app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_EXTENSIONS&#39;</span>]:
                abort(<span style="color: #0000DD; font-weight: bold">400</span>)
            uploaded_file<span style="color: #333333">.</span>save(os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>join(app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_PATH&#39;</span>], filename))  <span style="color: #888888"># &lt;--------- new update</span>
        <span style="color: #008800; font-weight: bold">return</span> redirect(url_for(<span style="background-color: #fff0f0">&#39;index&#39;</span>))
    <span style="color: #008800; font-weight: bold">return</span> render_template(<span style="background-color: #fff0f0">&#39;index.html&#39;</span>, title<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Home&#39;</span>, form<span style="color: #333333">=</span>form)
</pre>
<p>Every time a new upload is made, we now want the files to be organized and stored in one location within the top-level directory when the <code>save()</code> method is called. Go ahead and create an <code>uploads</code> directory in the application&#39;s root directory. Then update your configration to allow for storage in the newly created folder, as follows:</p>
<p class="code-title">config.py: path to uploads folder</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>


<span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Config</span>(<span style="color: #007020">object</span>):
    SECRET_KEY <span style="color: #333333">=</span> os<span style="color: #333333">.</span>environ<span style="color: #333333">.</span>get(<span style="background-color: #fff0f0">&#39;SECRET_KEY&#39;</span>) <span style="color: #000000; font-weight: bold">or</span> <span style="background-color: #fff0f0">&#39;you-will-never-guess&#39;</span>
    MAX_CONTENT_LENGTH <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1024</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">1024</span>
    UPLOAD_EXTENSIONS <span style="color: #333333">=</span> [<span style="background-color: #fff0f0">&#39;.jpg&#39;</span>, <span style="background-color: #fff0f0">&#39;.png&#39;</span>, <span style="background-color: #fff0f0">&#39;.gif&#39;</span>]
    UPLOAD_PATH <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;uploads&#39;</span>  <span style="color: #888888"># &lt; ------- new update</span>
</pre>
<h4 id="validate-file-content">Validate File Content</h4>
<p>Say your application allows only for <strong>image files</strong> to be uploaded. It is possible to first check the content of the uploaded file before accepting it.</p>
<p>Python provides the <a href="https://docs.python.org/3/library/imghdr.html">imghdr</a> package to validate that the file&#39;s header is actually an image file.</p>
<p class="code-title">routes.py: validate file content</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> render_template, url_for, request, redirect, abort
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app.forms</span> <span style="color: #008800; font-weight: bold">import</span> UploadForm
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">os</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">imghdr</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">werkzeug.utils</span> <span style="color: #008800; font-weight: bold">import</span> secure_filename
    
    
<span style="color: #888888"># new update</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">validate_image</span>(stream):
    header <span style="color: #333333">=</span> stream<span style="color: #333333">.</span>read(<span style="color: #0000DD; font-weight: bold">512</span>)
    stream<span style="color: #333333">.</span>seek(<span style="color: #0000DD; font-weight: bold">0</span>)
    format <span style="color: #333333">=</span> imghdr<span style="color: #333333">.</span>what(<span style="color: #007020">None</span>, header)
    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> format:
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #007020">None</span>
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&#39;.&#39;</span> <span style="color: #333333">+</span> (format <span style="color: #008800; font-weight: bold">if</span> format <span style="color: #333333">!=</span> <span style="background-color: #fff0f0">&#39;jpeg&#39;</span> <span style="color: #008800; font-weight: bold">else</span> <span style="background-color: #fff0f0">&#39;jpg&#39;</span>)
    
    
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/index&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>():
    form <span style="color: #333333">=</span> UploadForm()
    <span style="color: #008800; font-weight: bold">if</span> request<span style="color: #333333">.</span>method <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;POST&#39;</span>:
        uploaded_file <span style="color: #333333">=</span> request<span style="color: #333333">.</span>files[<span style="background-color: #fff0f0">&#39;file&#39;</span>]
        filename <span style="color: #333333">=</span> secure_filename(uploaded_file<span style="color: #333333">.</span>filename)
        <span style="color: #008800; font-weight: bold">if</span> filename <span style="color: #333333">!=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>:
            file_ext <span style="color: #333333">=</span> os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>splitext(filename)[<span style="color: #0000DD; font-weight: bold">1</span>]
            <span style="color: #888888"># updated</span>
            <span style="color: #008800; font-weight: bold">if</span> file_ext <span style="color: #000000; font-weight: bold">not</span> <span style="color: #000000; font-weight: bold">in</span> app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_EXTENSIONS&#39;</span>] <span style="color: #000000; font-weight: bold">or</span> \
                    file_ext <span style="color: #333333">!=</span> validate_image(uploaded_file<span style="color: #333333">.</span>stream):
                <span style="color: #888888"># end of update</span>
                abort(<span style="color: #0000DD; font-weight: bold">400</span>)
            uploaded_file<span style="color: #333333">.</span>save(os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>join(app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_PATH&#39;</span>], filename))  <span style="color: #888888"># &lt;--------- new update</span>
        <span style="color: #008800; font-weight: bold">return</span> redirect(url_for(<span style="background-color: #fff0f0">&#39;index&#39;</span>))
    <span style="color: #008800; font-weight: bold">return</span> render_template(<span style="background-color: #fff0f0">&#39;index.html&#39;</span>, title<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Home&#39;</span>, form<span style="color: #333333">=</span>form)
</pre>
<p><code>validate_image()</code> function reads 512 bytes of data when a file is first uploaded, and quickly resets the pointer to 0 before the file is saved. 512 bytes is sufficient data to identify an image.</p>
<p><code>imghdr.what()</code> function looks at the data stored in memory if the first argument is <code>None</code>, and then passed that data to the second argument. This function will primarily return the <em>image format</em>. If an unknown format is detected (the function supports a variety of image formats such as <code>jpeg</code>, <code>gif</code> etc), it returns a <code>None</code> value. </p>
<p>If an image format is detected, the function will return the format. However, to make good use of the returned file format, we&#39;d rather have our application return the file extension. We add <code>.</code> for all image formats except <code>jpeg</code>, which normally uses <code>jpg</code>.</p>
<p>Browse the complete code for securing files <a href="https://github.com/GitauHarrison/handling-file-uploads-in-flask/commit/e27bcfb72514c1c6185acdbb1c5449d7ab752d63">here</a>.</p>
<h3 id="consuming-uploaded-files">Consuming Uploaded files</h3>
<p>To be able to make use of the uploaded files, we need to access the <em>uploads</em> folder, which is currently located at the top-level directory. Normally, all static files are organized in a static sub-folder inside the <em>app</em> folder.</p>
<p>One advantage we will have working with the uploads folder outside the static sub-folder is that we can create a route specifically used to access the folder contents. Being able to work with a route directly allows for the use of <code>@login_required</code> to help protect the contents inside the folder.</p>
<p>Let us go ahead an update our <code>routes.py</code> file to access the uploads folder content:</p>
<p class="code-title">routes.py: access folder content</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">flask</span> <span style="color: #008800; font-weight: bold">import</span> send_from_directory


<span style="color: #555555; font-weight: bold">@app.routes</span>(<span style="background-color: #fff0f0">&#39;/uploads/&lt;filename&gt;&#39;</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">upload</span>(filename):
    <span style="color: #008800; font-weight: bold">return</span> send_from_directory(app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_PATH&#39;</span>], filename)
</pre>
<p>Additionally, we need to send the file contents to our <code>index()</code> function  for rendering.</p>
<p class="code-title">routes.py: render content from uploads directory</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #555555; font-weight: bold">@app.route</span>(<span style="background-color: #fff0f0">&#39;/index&#39;</span>, methods<span style="color: #333333">=</span>[<span style="background-color: #fff0f0">&#39;GET&#39;</span>, <span style="background-color: #fff0f0">&#39;POST&#39;</span>])
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">index</span>():
    form <span style="color: #333333">=</span> UploadForm()
    files <span style="color: #333333">=</span> os<span style="color: #333333">.</span>listdir(app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_PATH&#39;</span>])  <span style="color: #888888"># &lt;------- new</span>
    <span style="color: #008800; font-weight: bold">if</span> request<span style="color: #333333">.</span>method <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;POST&#39;</span>:
        uploaded_file <span style="color: #333333">=</span> request<span style="color: #333333">.</span>files[<span style="background-color: #fff0f0">&#39;file&#39;</span>]
        filename <span style="color: #333333">=</span> secure_filename(uploaded_file<span style="color: #333333">.</span>filename)
        <span style="color: #008800; font-weight: bold">if</span> filename <span style="color: #333333">!=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>:
            file_ext <span style="color: #333333">=</span> os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>splitext(filename)[<span style="color: #0000DD; font-weight: bold">1</span>]
            <span style="color: #008800; font-weight: bold">if</span> file_ext <span style="color: #000000; font-weight: bold">not</span> <span style="color: #000000; font-weight: bold">in</span> app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_EXTENSIONS&#39;</span>] <span style="color: #000000; font-weight: bold">or</span> \
                    file_ext <span style="color: #333333">!=</span> validate_image(uploaded_file<span style="color: #333333">.</span>stream):
                abort(<span style="color: #0000DD; font-weight: bold">400</span>)
            uploaded_file<span style="color: #333333">.</span>save(os<span style="color: #333333">.</span>path<span style="color: #333333">.</span>join(app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_PATH&#39;</span>], filename))
        <span style="color: #008800; font-weight: bold">return</span> redirect(url_for(<span style="background-color: #fff0f0">&#39;index&#39;</span>))
    <span style="color: #008800; font-weight: bold">return</span> render_template(<span style="background-color: #fff0f0">&#39;index.html&#39;</span>, title<span style="color: #333333">=</span><span style="background-color: #fff0f0">&#39;Home&#39;</span>, form<span style="color: #333333">=</span>form, files<span style="color: #333333">=</span>files)
</pre>
<p>To display the loaded files, we need to loop through all available content in the <em>uploads</em> folder.</p>
<p class="code-title">index.html: display content in uploads folder</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> Remove back slashes <span style="color: #333333">--&gt;</span>

{<span style="color: #333333">%</span> extends <span style="background-color: #fff0f0">&quot;base.html&quot;</span> <span style="color: #333333">%</span>}
{<span style="color: #333333">%</span> <span style="color: #008800; font-weight: bold">import</span> <span style="background-color: #fff0f0">&#39;bootstrap/wtf.html&#39;</span> <span style="color: #008800; font-weight: bold">as</span> wtf <span style="color: #333333">%</span>}
    
{<span style="color: #333333">%</span> block app_content <span style="color: #333333">%</span>}
    <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;row&quot;</span><span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-2&quot;</span><span style="color: #333333">&gt;</span>
            <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> empty <span style="color: #333333">--&gt;</span>
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-8&quot;</span><span style="color: #333333">&gt;</span>
            \{\{ wtf<span style="color: #333333">.</span>quick_form(form) \}\}             
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-2&quot;</span><span style="color: #333333">&gt;</span>
                <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> empty <span style="color: #333333">--&gt;</span>
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>        
    <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;&lt;</span>hr<span style="color: #333333">&gt;</span>
    
    <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> display content <span style="color: #000000; font-weight: bold">in</span> uploads folder <span style="color: #333333">--&gt;</span>
    <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;row&quot;</span><span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-2&quot;</span><span style="color: #333333">&gt;</span>
            {<span style="color: #333333">%</span> <span style="color: #008800; font-weight: bold">for</span> <span style="color: #007020">file</span> <span style="color: #000000; font-weight: bold">in</span> files <span style="color: #333333">%</span>}
                <span style="color: #333333">&lt;</span>img src<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;\{\{ url_for(&#39;upload&#39;, filename=file) \}\}&quot;</span> style<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;width: 64px;&quot;</span><span style="color: #333333">&gt;</span>
            {<span style="color: #333333">%</span> endfor <span style="color: #333333">%</span>}
        <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
    <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>
    <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> end of display <span style="color: #333333">--&gt;</span>
       
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
</pre>
<p>When you reload your page, you should be able to see tumbnails of the images from your <em>uploads</em> directory.</p>
<h3 id="the-miracle-of-dropzone-js">The Miracle of Dropzone.js</h3>
<p><a href="https://www.dropzonejs.com/">dropzone.js</a> is a popular upload client. So far, we have been using default browser widget to do the uploading. This JS client has the ability to show upload progress when uploading file, a useful feedback especially when uploading large files.</p>
<p>To incorporate it in our flask form, we first need to load dropzone CSS and Javascript from a CDN in our <code>base.html</code> file:</p>
<p class="code-title">base.html: load dropzone CSS and JS</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> Remove backslashes <span style="color: #333333">--&gt;</span>


<span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> Load CSS, place after head block <span style="color: #333333">--&gt;</span>
{<span style="color: #333333">%</span> block styles <span style="color: #333333">%</span>}
    \{\{ <span style="color: #007020">super</span>() \}\}
    <span style="color: #333333">&lt;</span>link rel<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;stylesheet&quot;</span> href<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/min/dropzone.min.css&quot;</span><span style="color: #333333">&gt;</span>
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
<span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> End CSS <span style="color: #333333">--&gt;</span>
    
<span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> JS block <span style="color: #000000; font-weight: bold">is</span> placed at the bottom <span style="color: #333333">--&gt;</span>
{<span style="color: #333333">%</span> block scripts <span style="color: #333333">%</span>}
    \{\{ <span style="color: #007020">super</span>() \}\}    
    <span style="color: #333333">&lt;</span>script src<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.7.1/min/dropzone.min.js&quot;</span><span style="color: #333333">&gt;&lt;/</span>script<span style="color: #333333">&gt;</span>
{<span style="color: #333333">%</span> endblock <span style="color: #333333">%</span>}
<span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> End JS <span style="color: #333333">--&gt;</span>
</pre>
<p>Then update <code>forms.py</code> file to render the <code>dropzone</code> class as a keyword argument to the <code>FileField</code>:</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">UploadForm</span>(FlaskForm):
    <span style="color: #007020">file</span> <span style="color: #333333">=</span> FileField(<span style="background-color: #fff0f0">&#39;Upload File&#39;</span>, render_kw<span style="color: #333333">=</span>{<span style="background-color: #fff0f0">&quot;class&quot;</span>: <span style="background-color: #fff0f0">&quot;dropzone&quot;</span>})
</pre>
<p>This is what you get:</p>
<p><img class="img-fluid" style="max-width: 100%; height: auto;" src="{{ url_for('static', filename='/images/file_uploads/unattractive_dropzone_js.png') }}" alt="Dropzone.js"></p>
<p>To get rid of the browser widget, we will resort to manually creating our form without using <code>flask-bootstrap</code> as shown below:</p>
<p class="code-title">index.html: manually create form</p>
<pre style="margin: 30; line-height: 125%">
<span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> Remove back slashes<span style="color: #333333">--&gt;</span>
    
<span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;row&quot;</span><span style="color: #333333">&gt;</span>       
    <span style="color: #333333">&lt;</span>div class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;col-sm-12 col-md-4 col-lg-8&quot;</span><span style="color: #333333">&gt;</span>
        <span style="color: #333333">&lt;</span><span style="color: #ff8080; ">!</span><span style="color: #333333">--</span> \{\{ wtf<span style="color: #333333">.</span>quick_form(form) \}\} <span style="color: #333333">--&gt;</span>
        <span style="color: #333333">&lt;</span>form action<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;\{\{ url_for(&#39;index&#39;) \}\}&quot;</span> class<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;dropzone&quot;</span> method<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;POST&quot;</span> enctype<span style="color: #333333">=</span><span style="background-color: #fff0f0">&quot;multipart/form-data&quot;</span> novalidate<span style="color: #333333">&gt;</span>
            \{\{ form<span style="color: #333333">.</span>hidden_tag() \}\}                        
        <span style="color: #333333">&lt;/</span>form<span style="color: #333333">&gt;</span>
    <span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;</span>            
<span style="color: #333333">&lt;/</span>div<span style="color: #333333">&gt;&lt;</span>hr<span style="color: #333333">&gt;</span>
</pre>
<p>Note that the action attribute has been set to load from the <code>index()</code>  method URL. </p>
<p>The enctype attribute in the <code>&lt;form&gt;</code> element is normally not included with forms that don&#39;t have files. This attribute defines how the browser should format the data before it is submitted to the server. </p>
<p><code>multipart/form-data</code> is a format that is required when at least one of the fields in the form is a file field.</p>
<p>With that, you can now drag and drop files into the form and it will automatically be downloaded to the <em>uploads</em> folder, with indicators for both progression and status of the final upload(whether successful or not).</p>
<p>One thing you will not is that when the uploaded file fails either of our application&#39;s configurations setting, dropzone does make an effort to display a message. This message, however, is not easily readable.</p>
<p><img class="img-fluid" style="max-width: 100%; height: auto;" src="{{ url_for('static', filename='/images/file_uploads/dropzone_error_msg.png') }}" alt="Dropzone Error Message"></p>
<p>The 413 File too Large error message is generated by Flask when the payload exceeds the capacity limit. We can overide the default error message be creating our own custom error message.</p>
<p class="code-title">errors.py: create custom error message</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">app</span> <span style="color: #008800; font-weight: bold">import</span> app


<span style="color: #555555; font-weight: bold">@app.errorhandler</span>(<span style="color: #0000DD; font-weight: bold">413</span>)
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">file_too_large</span>(error):
    <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&#39;File is too large&#39;</span>, <span style="color: #0000DD; font-weight: bold">413</span>
</pre>
<p>What about when the file upload process fails the other configurations other than too large a file? We need to update our <code>index()</code> function to accomodate this.</p>
<pre style="margin: 30; line-height: 125%"><span style="color: #008800; font-weight: bold">if</span> file_ext <span style="color: #000000; font-weight: bold">not</span> <span style="color: #000000; font-weight: bold">in</span> app<span style="color: #333333">.</span>config[<span style="background-color: #fff0f0">&#39;UPLOAD_EXTENSIONS&#39;</span>] <span style="color: #000000; font-weight: bold">or</span> \
    file_ext <span style="color: #333333">!=</span> validate_image(uploaded_file<span style="color: #333333">.</span>stream):
<span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&#39;Invalid image&#39;</span>, <span style="color: #0000DD; font-weight: bold">400</span>
</pre>
<p>That&#39;s it! Your flask application can now safely consume file uploads.</p>
<p>You can browse <a href="https://github.com/GitauHarrison/handling-file-uploads-in-flask">the completed projet on GitHub</a>.</p>




        </div>
    </div><hr>
    <!-- Comments Section -->
    <div class="row">            
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
            <h3 id="comments">{{ total }} Comments</h3>  
            <div class="translate-info">Feel free to post your comment in your language</div>

            <!-- Display Flash Messages Here -->
            {% include '_flash_message.html' %}

            <!-- Comments Go Here -->
            {% for post in all_allowed_comments %}
                {% include '_comments.html' %}
            {% endfor %}

            <!-- Pagination Links -->
            <nav aria-label="...">
                <ul class="pager">
                    <li class="previous{% if not prev_url %} disabled{% endif %}">
                        <a href="{{ prev_url or '#' }}">
                            <span aria-hidden="true">&larr;</span> Newer Comments
                        </a>
                    </li>
                    <li class="next{% if not next_url %} disabled{% endif %}">
                        <a href="{{ next_url or '#' }}">
                            Older Comments <span aria-hidden="true">&rarr;</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Comment Form Goes Here -->
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-6 my-form">
                    {{ wtf.quick_form(form) }}
                </div>
            </div>            
        </div>
    </div>
{% endblock %}